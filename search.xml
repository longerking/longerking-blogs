<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ChatGLM-Deploy-FastChat</title>
    <url>/longerking-blogs/2023/08/15/chatglm-deploy-fastchat/</url>
    <content><![CDATA[<h1 id="ChatGLM-Deploy-FastChat"><a href="#ChatGLM-Deploy-FastChat" class="headerlink" title="ChatGLM-Deploy-FastChat"></a>ChatGLM-Deploy-FastChat</h1><p>åˆ©ç”¨FastChatéƒ¨ç½²ChatGLM</p>
<p>Reference</p>
<blockquote>
<p><a class="link"   href="https://github.com/lm-sys/FastChathttps://github.com/lm-sys/FastChat/blob/main/docs/openai/_api.md" >https://github.com/lm-sys/FastChathttps://github.com/lm-sys/FastChat/blob/main/docs/openai\_api.md<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<p><br><code>Note</code>ï¼š ä¸€äº›screençª—å£ä¼šè¯çŸ¥è¯†é¢„å¤‡</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">screen <span class="literal">-S</span> fs<span class="literal">-glm-wkr</span> <span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸ºfs-glm-wkrçš„ä¼šè¯</span></span><br><span class="line"><span class="comment"># ctrl+shift+d # é€€å‡ºå½“å‰ä¼šè¯çª—å£ï¼Œä½†ä¼šè¯å†…å®¹ä¿æŒåå°</span></span><br><span class="line">screen <span class="literal">-r</span> fs<span class="literal">-glm-wkr</span> <span class="comment"># è¿æ¥åˆ° fs-glm-wkr ä¼šè¯çª—å£</span></span><br><span class="line"><span class="comment"># ctrl+d # é€€å‡ºä¼šè¯çª—å£ï¼Œå¹¶åœæ­¢æ•´ä¸ªçª—å£å†…ç¨‹åº</span></span><br><span class="line">screen <span class="literal">-ls</span> <span class="comment"># æŸ¥çœ‹æ‰€æœ‰ä¼šè¯çª—å£</span></span><br><span class="line">screen <span class="literal">-D</span> <span class="literal">-r</span> fs<span class="literal">-glm-wkr</span> <span class="comment"># å¼ºåˆ¶é‡è¿å·²ç»AttactedçŠ¶æ€çš„çª—å£</span></span><br></pre></td></tr></table></figure>

<p>\</p>
<h3 id="Install-FastChat"><a href="#Install-FastChat" class="headerlink" title="Install FastChat"></a>Install FastChat</h3><p>ä½¿ç”¨ä¾èµ–åŒ…å®‰è£…æˆ–è€…ä½¿ç”¨æºç å®‰è£…ï¼ŒäºŒé€‰ä¸€å³å¯ã€‚å¦‚æœFastChatè¿˜ä¸æ”¯æŒçš„æ¨¡å‹ï¼Œå»ºè®®ä½¿ç”¨æºç å®‰è£…ï¼Œå†æºç é›†æˆæ”¯æŒæ¨¡å‹ååœ¨æºç å®‰è£…ä¾èµ–åŒ…ã€‚ <code>Note</code>: FastChatæ”¯æŒå¯¹æ¥chatglmæ˜¯å› ä¸ºæºç ä¸­ï¼Œå·²ç»åšäº†è¿™éƒ¨åˆ†çš„é…ç½®é›†æˆã€‚è¿™é‡Œçš„æµ‹è¯•ä½¿ç”¨pipå®‰è£…ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">pip3 install fschat</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">git clone https://github.com/lm<span class="literal">-sys</span>/FastChat.git</span><br><span class="line"><span class="built_in">cd</span> FastChat</span><br><span class="line">pip3 install <span class="literal">--upgrade</span> pip  <span class="comment"># enable PEP 660 support</span></span><br><span class="line">pip3 install <span class="literal">-e</span> .</span><br></pre></td></tr></table></figure>

<p>\</p>
<h3 id="Load-Models"><a href="#Load-Models" class="headerlink" title="Load Models"></a>Load Models</h3><p>æœåŠ¡å™¨éƒ¨ç½²æ¨¡å‹ï¼Œå¹¶æä¾›lç±»ä¼¼gpt çš„ openai æ¥å£æ–¹å¼è®¿é—®ã€‚</p>
<ol>
<li><h4 id="Use-serve-cli-testing-model"><a href="#Use-serve-cli-testing-model" class="headerlink" title="Use serve.cli testing model"></a>Use serve.cli testing model</h4></li>
</ol>
<p>cliè¿è¡Œè„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 <span class="literal">-m</span> fastchat.serve.cli \</span><br><span class="line">        <span class="literal">--model-path</span> /mnt/models/chatglm2<span class="literal">-6b</span></span><br></pre></td></tr></table></figure>

<p>å¦‚å›¾ï¼Œä¼šåœ¨ç»ˆç«¯ç”Ÿæˆå¦‚ä¸‹äº¤äº’é—®ç­”</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(chatglm)longer@codeWL<span class="variable">$</span> python3 <span class="literal">-m</span> fastchat.serve.cli <span class="literal">--model-path</span> /mnt/models/chatglm2<span class="literal">-6b</span></span><br><span class="line">Loading checkpoint shards: <span class="number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="number">16</span>/<span class="number">16</span> [<span class="number">00</span>:<span class="number">13</span>&lt;<span class="number">00</span>:<span class="number">00</span>,  <span class="number">1.18</span><span class="type">it</span>/<span class="type">s</span>]</span><br><span class="line">é—®: ä½ æ˜¯è°ï¼Ÿ</span><br><span class="line">ç­”: æˆ‘æ˜¯ä¸€ä¸ªåä¸º ChatGLM2<span class="literal">-6B</span> çš„äººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œæ˜¯åŸºäºæ¸…åå¤§å­¦ KEG å®éªŒå®¤å’Œæ™ºè°± AI å…¬å¸äº <span class="number">2023</span> å¹´å…±åŒè®­ç»ƒçš„è¯­è¨€æ¨¡å‹å¼€å‘çš„ã€‚æˆ‘çš„ä»»åŠ¡æ˜¯é’ˆå¯¹ç”¨æˆ·çš„é—®é¢˜å’Œè¦æ±‚æä¾›é€‚å½“çš„ç­”å¤å’Œæ”¯æŒã€‚</span><br><span class="line">é—®: å¦‚ä½•ä½¿ç”¨fastchat</span><br><span class="line">ç­”: Fastchat æ˜¯ä¸€ä¸ªåŸºäº Python çš„èŠå¤©åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ä½¿ç”¨å®ƒè¿›è¡Œæ–‡æœ¬æˆ–è¯­éŸ³èŠå¤©ã€‚è¦ä½¿ç”¨ Fastchatï¼Œæ‚¨éœ€è¦é¦–å…ˆå®‰è£…å®ƒã€‚åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… Fastchatï¼š</span><br><span class="line">```</span><br><span class="line">pip install fastchat</span><br><span class="line">```</span><br><span class="line">å®‰è£…å®Œæˆåï¼Œæ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Fastchatï¼š</span><br><span class="line">```</span><br><span class="line">fastchat</span><br><span class="line">```</span><br><span class="line">ç„¶åï¼Œæ‚¨å¯ä»¥é€šè¿‡è¾“å…¥ <span class="string">&quot;ä½ å¥½&quot;</span> æ¥å¯åŠ¨ Fastchat çš„è¯­éŸ³èŠå¤©åŠŸèƒ½ã€‚</span><br><span class="line">```</span><br><span class="line">fastchat ä½ å¥½</span><br><span class="line">```</span><br><span class="line">åœ¨ Fastchat ä¸­ï¼Œæ‚¨å¯ä»¥å‘å¯¹æ–¹å‘é€æ–‡æœ¬æ¶ˆæ¯æˆ–è¯­éŸ³æ¶ˆæ¯ã€‚åœ¨å‘é€æ–‡æœ¬æ¶ˆæ¯æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ emoji è¡¨æƒ…ç¬¦å·å’Œè¡¨æƒ…ç¬¦æ¥ä½¿æ¶ˆæ¯æ›´åŠ ç”ŸåŠ¨ã€‚ä¾‹å¦‚ï¼Œè¦å‘é€ä¸€ä¸ªå¸¦æœ‰å¼€å¿ƒè¡¨æƒ…çš„è¡¨æƒ…ç¬¦å·ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š</span><br><span class="line">```</span><br><span class="line">fastchat :(</span><br><span class="line">```</span><br><span class="line">è¦å‘é€ä¸€ä¸ªå¸¦æœ‰å“­æ³£è¡¨æƒ…çš„è¡¨æƒ…ç¬¦å·ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š</span><br><span class="line">```</span><br><span class="line">fastchat :<span class="string">&#x27;(</span></span><br><span class="line"><span class="string">```</span></span><br><span class="line"><span class="string">æ­¤å¤–ï¼ŒFastchat è¿˜æ”¯æŒå‘é€è¯­éŸ³æ¶ˆæ¯ã€‚è¦å‘é€è¯­éŸ³æ¶ˆæ¯ï¼Œè¯·é¦–å…ˆè¯·ç¡®ä¿æ‚¨çš„è®¡ç®—æœºå·²å®‰è£…äº†æµè§ˆå™¨ï¼Œå¹¶å°† Fastchat çš„è¯­éŸ³æ¶ˆæ¯ URL å¤åˆ¶åˆ°æµè§ˆå™¨ä¸­ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç å‘é€è¯­éŸ³æ¶ˆæ¯ï¼š</span></span><br><span class="line"><span class="string">```</span></span><br><span class="line"><span class="string">fastchat :(4437912ï¼šæ‚¨æƒ³è¯´ä»€ä¹ˆ</span></span><br><span class="line"><span class="string">```</span></span><br><span class="line"><span class="string">è¿™å°†åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šæ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨ï¼Œå¹¶åœ¨ Fastchat ä¸­æ˜¾ç¤ºæ‚¨è¾“å…¥çš„è¯­éŸ³æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="string">é—®:</span></span><br></pre></td></tr></table></figure>

<p>\</p>
<ol start="2">
<li><h4 id="serve-controller-for-RESTful-API-Server"><a href="#serve-controller-for-RESTful-API-Server" class="headerlink" title="serve.controller for RESTful API Server"></a>serve.controller for RESTful API Server</h4></li>
</ol>
<p><strong>First Lunch a fastchat.serve.controllerã€‚</strong></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># screen -S fs-glm-ctl</span></span><br><span class="line">python3 <span class="literal">-m</span> fastchat.serve.controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºå¦‚ä¸‹</span></span><br><span class="line">(chatglm)longer@codeWL<span class="variable">$</span> python3 <span class="literal">-m</span> fastchat.serve.controller</span><br><span class="line"><span class="number">2023</span><span class="literal">-08-01</span> <span class="number">07</span>:<span class="number">15</span>:<span class="number">20</span> | INFO | controller | args: Namespace(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">21001</span>, dispatch_method=<span class="string">&#x27;shortest_queue&#x27;</span>)</span><br><span class="line"><span class="number">2023</span><span class="literal">-08-01</span> <span class="number">07</span>:<span class="number">15</span>:<span class="number">20</span> | ERROR | stderr | INFO:     Started server <span class="keyword">process</span> [<span class="number">18496</span>]</span><br><span class="line"><span class="number">2023</span><span class="literal">-08-01</span> <span class="number">07</span>:<span class="number">15</span>:<span class="number">20</span> | ERROR | stderr | INFO:     Waiting <span class="keyword">for</span> application startup.</span><br><span class="line"><span class="number">2023</span><span class="literal">-08-01</span> <span class="number">07</span>:<span class="number">15</span>:<span class="number">20</span> | ERROR | stderr | INFO:     Application startup complete.</span><br><span class="line"><span class="number">2023</span><span class="literal">-08-01</span> <span class="number">07</span>:<span class="number">15</span>:<span class="number">20</span> | ERROR | stderr | INFO:     Uvicorn running on http://localhost:<span class="number">21001</span> (Press CTRL+C to quit)</span><br></pre></td></tr></table></figure>

<p><strong>Then, launch the model worker(s)</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  screen -S fs-glm-wkr</span></span><br><span class="line">python3 -m fastchat.serve.model_worker --model-path /mnt/models/chatglm2-6b</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>\</p>
<p><strong>Finally, launch the RESTful API server</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> screen -S fs-glm-api</span></span><br><span class="line">python3 -m fastchat.serve.openai_api_server --host localhost --port 8000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">localhost å»ºè®®ä½¿ç”¨å±€åŸŸç½‘æˆ–è€…å…¬ç½‘åœ°å€ï¼Œè¿™æ˜¯å¯¹å¤–çš„apiæ¥å£</span></span><br></pre></td></tr></table></figure>

<p><br><code>Note</code>: ä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤éƒ½æ˜¯å¿…é¡»æŒ‰ç…§æ­¥éª¤å…¨éƒ¨æ‰§è¡Œã€‚å¯ä»¥ä½¿ç”¨screen sessionä¼šè¯ä¾æ¬¡åå°æ‰§è¡Œè¿™äº›æœåŠ¡ã€‚\</p>
<p><strong>Launch the Gradio web server</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨fastchat gradioé¡µé¢æ¥æŸ¥çœ‹åŠ è½½çš„æ¨¡å‹</span></span><br><span class="line"><span class="comment"># screen -S fs-glm-grd</span></span><br><span class="line">python3 -m fastchat.serve.gradio_web_server</span><br><span class="line"><span class="comment"># ... </span></span><br><span class="line"><span class="comment"># Running on local URL:  http://0.0.0.0:7860</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>Grade web Pageï¼šä¸Šé¢çš„model_workeråªé€‰æ‹©äº†ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¾ç¤ºå·²ç»åŠ è½½çš„æ¨¡å‹ã€‚å¦‚æœè¦æ”¯æŒå¤šä¸ªæ¨¡å‹å¯ä»¥çœ‹ä¸‹æ–‡çš„<strong>Running Mutiple</strong>ï¼Œå½“ç„¶è¿™ä¸ªä¹Ÿéœ€è¦æ˜¾å­˜æ”¯æŒã€‚</p>
<h3 id="Test-APIs"><a href="#Test-APIs" class="headerlink" title="Test APIs"></a>Test APIs</h3><h4 id="Interact-with-modeï¼ˆOpenAIæ–¹å¼ï¼‰"><a href="#Interact-with-modeï¼ˆOpenAIæ–¹å¼ï¼‰" class="headerlink" title="Interact with modeï¼ˆOpenAIæ–¹å¼ï¼‰"></a>Interact with modeï¼ˆOpenAIæ–¹å¼ï¼‰</h4><blockquote>
<p><a class="link"   href="http://hostserver:8000/v1/" >http://hostserver:8000/v1/<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<p>è¿è¡Œ <code>chatglm.py</code> è„šæœ¬ä¼šå¾—åˆ°å¦‚ä¸‹çš„ResponseText</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(chatai) <span class="built_in">PS</span> E:\TestGLM\src&gt; python chatglm.py</span><br><span class="line">ä½ å¥½ï¼Œä½œä¸ºä¸€åäººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œæˆ‘æ— æ³•æ„Ÿå—åˆ°æƒ…æ„Ÿï¼Œä½†æˆ‘å¯ä»¥æä¾›å¸®åŠ©ã€‚ è¯·é—®æœ‰ä»€ä¹ˆé—®é¢˜æˆ‘å¯ä»¥è§£ç­”å—ï¼Ÿ</span><br><span class="line">Hello! My name is Noxix. I am an AI chatbot designed to assist you with any questions or tasks you may have. How can I help you today?</span><br></pre></td></tr></table></figure>

<p><code>chatglm.py</code> å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pip install --upgrade openai</span></span><br><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="comment"># to get proper authentication, make sure to use a valid key that&#x27;s listed in</span></span><br><span class="line"><span class="comment"># the --api-keys flag. if no flag value is provided, the `api_key` will be ignored.</span></span><br><span class="line">openai.api_key = <span class="string">&quot;EMPTY&quot;</span></span><br><span class="line">openai.api_base = <span class="string">&quot;http://yourserverip:8000/v1&quot;</span></span><br><span class="line"></span><br><span class="line">model = <span class="string">&quot;chatglm2-6b&quot;</span>  <span class="comment"># æ¨¡å‹æ–‡ä»¶åœ°å€ï¼Œæ–‡ä»¶å¤¹åå­—</span></span><br><span class="line">prompt = <span class="string">&quot;ä½ å¥½&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create a completion</span></span><br><span class="line">completion = openai.Completion.create(model=model, prompt=prompt, max_tokens=<span class="number">64</span>)</span><br><span class="line"><span class="comment"># print the completion</span></span><br><span class="line"><span class="built_in">print</span>(prompt + completion.choices[<span class="number">0</span>].text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># create a chat completion</span></span><br><span class="line">completion = openai.ChatCompletion.create(</span><br><span class="line">  model=model,</span><br><span class="line">  messages=[&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;Hello! What is your name?&quot;</span>&#125;]</span><br><span class="line">)</span><br><span class="line"><span class="comment"># print the completion</span></span><br><span class="line"><span class="built_in">print</span>(completion.choices[<span class="number">0</span>].message.content)</span><br><span class="line"></span><br><span class="line"><span class="comment">#########################ç±»ä¼¼openaçš„ä»£ç ##################################</span></span><br><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">**args</span>):</span><br><span class="line">    openai.api_key = <span class="string">&quot;EMPTY&quot;</span></span><br><span class="line">    openai.api_base = <span class="string">&quot;http://hostserver:8000/v1&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = openai.ChatCompletion.create(**args)</span><br><span class="line">    <span class="keyword">except</span> openai.error.RateLimitError:</span><br><span class="line">        result = create(**args)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chat</span>(<span class="params">mess</span>):</span><br><span class="line">    responde = create(</span><br><span class="line">        model=<span class="string">&quot;chatglm2-6b&quot;</span>,</span><br><span class="line">        messages=mess</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    res = responde[<span class="string">&#x27;choices&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;message&#x27;</span>][<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>

<h4 id="List-Models"><a href="#List-Models" class="headerlink" title="List Models"></a>List Models</h4><blockquote>
<p><a class="link"   href="http://hostserver:8000/v1/models" >http://hostserver:8000/v1/models<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<p>Using CMD <code>curl http://hostserver:8000/v1/models</code>ï¼Œ then</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// curl http://hostserver:8000/v1/models</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;object&quot;</span><span class="punctuation">:</span> <span class="string">&quot;list&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatglm2-6b&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;object&quot;</span><span class="punctuation">:</span> <span class="string">&quot;model&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="number">1690876019</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;owned_by&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fastchat&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;root&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatglm2-6b&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;permission&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;modelperm-37FkwejmTx3qArXrHS5uSv&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;object&quot;</span><span class="punctuation">:</span> <span class="string">&quot;model_permission&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="number">1690876019</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;allow_create_engine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;allow_sampling&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;allow_logprobs&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;allow_search_indices&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;allow_view&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;allow_fine_tuning&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;organization&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;is_blocking&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Chat-Completions"><a href="#Chat-Completions" class="headerlink" title="Chat Completions"></a>Chat Completions</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://localhost:8000/v1/chat/completions \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;    &quot;model&quot;: &quot;vicuna-7b-v1.3&quot;,    &quot;messages&quot;: [&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Hello! What is your name?&quot;&#125;]  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Text-Completions"><a href="#Text-Completions" class="headerlink" title="Text Completions"></a>Text Completions</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://localhost:8000/v1/completions \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;    &quot;model&quot;: &quot;vicuna-7b-v1.3&quot;,    &quot;prompt&quot;: &quot;Once upon a time&quot;,    &quot;max_tokens&quot;: 41,    &quot;temperature&quot;: 0.5  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Embeddings"><a href="#Embeddings" class="headerlink" title="Embeddings:"></a>Embeddings:</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://localhost:8000/v1/embeddings \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;    &quot;model&quot;: &quot;vicuna-7b-v1.3&quot;,    &quot;input&quot;: &quot;Hello world!&quot;  &#125;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="Running-Multipleï¼ˆTODO-TEST-å¤šæ¨¡å‹åŠ è½½ï¼‰"><a href="#Running-Multipleï¼ˆTODO-TEST-å¤šæ¨¡å‹åŠ è½½ï¼‰" class="headerlink" title="Running Multipleï¼ˆTODO TEST å¤šæ¨¡å‹åŠ è½½ï¼‰"></a>Running Multipleï¼ˆTODO TEST å¤šæ¨¡å‹åŠ è½½ï¼‰</h3><p>If you want to run multiple models on the same machine and in the same process, you can replace the <code>model_worker</code> step above with a multi model variant:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># screen -r fs-glm-wkr</span></span><br><span class="line"></span><br><span class="line">python3 -m fastchat.serve.multi_model_worker \</span><br><span class="line">    --model-path /mnt/models/chatglm2-6b-ptune \</span><br><span class="line">    --model-names chatglm2-6b-ptune</span><br><span class="line">    --model-path /mnt/models/chatglm2-6b \</span><br><span class="line">    --model-names chatglm2-6b </span><br></pre></td></tr></table></figure>

<p><code>Note</code> åŒæ—¶åŠ è½½å¤šä¸ªæ¨¡å‹ï¼Œè®¾ç½®æ¨¡å‹åç§°è·¯å¾„å³å¯ï¼Œéœ€è¦æ˜¾å­˜æ”¯æŒã€‚è¿™é‡Œå°è¯•è¿è¡Œäº†ä¸¤ä¸ªChatGLMä»¥åŠå¾®è°ƒChatGLM, æ˜¾ç„¶24Gçš„æ˜¾å­˜ä¸æ”¯æŒåŒæ—¶è¿è¡Œä¸¤ä¸ªã€‚æ•…ä¹‹åçš„æµ‹è¯•æ­¥éª¤æš‚ä¸æ‘˜å½•ã€‚<br>æ¥ä¸‹æ¥å°±æ„‰å¿«çš„ä½¿ç”¨openaiå»å¯¹æ¥chatglmåº”ç”¨å§ã€‚</p>
]]></content>
      <categories>
        <category>LLMs</category>
      </categories>
      <tags>
        <tag>LLMs</tag>
      </tags>
  </entry>
  <entry>
    <title>ChatGLM-Using</title>
    <url>/longerking-blogs/2023/08/15/chatglm-using/</url>
    <content><![CDATA[<p>å¤§è¯­è¨€æ¨¡å‹ä½¿ç”¨</p>
<h1 id="ChatGLM-Using"><a href="#ChatGLM-Using" class="headerlink" title="ChatGLM-Using"></a>ChatGLM-Using</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è‡ªä»OpenAI ChatGPTçˆ†ç«ä»¥æ¥ï¼Œå¼€æºç•Œ AIç•Œåˆ®èµ·äº†å¤§æ¨¡å‹ä¹‹é£ã€‚è¿™äº›å›½äº§å¤§æ¨¡å‹ï¼Œæˆ‘ä»¬å½“ç„¶è¦ä½“éªŒèµ·æ¥ã€‚æœ¬æ–‡ä¸»è¦ä»ä»£ç å±‚é¢è®°å½•äº†å¦‚ä½•è°ƒç”¨ä½“éªŒå¤§æ¨¡å‹ï¼Œä»ä¸€ä¸ªè°ƒåŒ…å·¥ç¨‹å¸ˆå‡çº§æˆä¸ºä¸€ä¸ªè°ƒç”¨å¤§æ¨¡å‹æ¨¡å‹å·¥ç¨‹å¸ˆã€‚:poop:</p>
<h2 id="ChatGLM2-6B"><a href="#ChatGLM2-6B" class="headerlink" title="ChatGLM2-6B"></a>ChatGLM2-6B</h2><p>ChatGLM2-6Bæ˜¯ç”±æ¸…åTHUDMå®éªŒå®¤å¼€æºçš„ä¸­è‹±åŒè¯­å¯¹è¯æ¨¡å‹ <a class="link"   href="https://github.com/THUDM/ChatGLM-6B" >ChatGLM-6B<i class="fas fa-external-link-alt"></i></a> çš„ç¬¬äºŒä»£ç‰ˆï¼Œæœ¬åŸºäº <a class="link"   href="https://github.com/THUDM/GLM" >General Language Model (GLM)<i class="fas fa-external-link-alt"></i></a> æ¶æ„ï¼Œå…·æœ‰ 62 äº¿å‚æ•°ã€‚ç»“åˆæ¨¡å‹é‡åŒ–æŠ€æœ¯ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ¶ˆè´¹çº§çš„æ˜¾å¡ä¸Šè¿›è¡Œæœ¬åœ°éƒ¨ç½²ï¼ˆINT4 é‡åŒ–çº§åˆ«ä¸‹æœ€ä½åªéœ€ 6GB æ˜¾å­˜ï¼‰ã€‚ ChatGLM-6B ä½¿ç”¨äº†å’Œ ChatGPT ç›¸ä¼¼çš„æŠ€æœ¯ï¼Œé’ˆå¯¹ä¸­æ–‡é—®ç­”å’Œå¯¹è¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚ç»è¿‡çº¦ 1T æ ‡è¯†ç¬¦çš„ä¸­è‹±åŒè¯­è®­ç»ƒï¼Œè¾…ä»¥ç›‘ç£å¾®è°ƒã€åé¦ˆè‡ªåŠ©ã€äººç±»åé¦ˆå¼ºåŒ–å­¦ä¹ ç­‰æŠ€æœ¯çš„åŠ æŒï¼Œ62 äº¿å‚æ•°çš„ ChatGLM-6B å·²ç»èƒ½ç”Ÿæˆç›¸å½“ç¬¦åˆäººç±»åå¥½çš„å›ç­”ã€‚</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote>
<ol>
<li><a class="link"   href="https://github.com/THUDM/ChatGLM2-6B" >https://github.com/THUDM/ChatGLM2-6B<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   href="https://huggingface.co/THUDM/chatglm2-6b" >https://huggingface.co/THUDM/chatglm2-6b<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   href="https://huggingface.co/THUDM/chatglm-6b-int4" >https://huggingface.co/THUDM/chatglm-6b-int4<i class="fas fa-external-link-alt"></i></a></li>
</ol>
</blockquote>
<h3 id="HardWare-Requirements"><a href="#HardWare-Requirements" class="headerlink" title="HardWare Requirements"></a>HardWare Requirements</h3><table><thead><tr><th width="149.33333333333331">é‡åŒ–ç­‰çº§</th><th width="277">ç¼–ç  2048 é•¿åº¦çš„æœ€å°æ˜¾å­˜</th><th>ç”Ÿæˆ 8192 é•¿åº¦çš„æœ€å°æ˜¾å­˜</th></tr></thead><tbody><tr><td>FP16 / BF16</td><td>13.1 GB</td><td>12.8 GB</td></tr><tr><td>INT8</td><td>8.2 GB</td><td>8.1 GB</td></tr><tr><td>INT4</td><td>5.5 GB</td><td>5.1 GB</td></tr></tbody></table>

<p>è¿™é‡Œå—é™äºèµ„æºï¼Œæˆ‘ä»¬ä»¥é‡åŒ–INT4çš„æ¨¡å‹æµ‹è¯•ï¼ŒåŒæ—¶INT4æ ¹æ®å®˜ç½‘ä»‹ç»æ”¯æŒCPUã€‚</p>
<h3 id="DownLoad-Models"><a href="#DownLoad-Models" class="headerlink" title="DownLoad Models"></a>DownLoad Models</h3><p>è¿™é‡Œç›´æ¥ä¸‹è½½Hugging Face(HF)ä¸Šçš„inté‡åŒ–åçš„æ¨¡å‹ã€‚HFæ˜¯ä¸€ä¸ªæ‰˜ç®¡å‘å¸ƒåˆ†äº«æ¨¡å‹æ•°æ®é›†çš„å¼€æºå¹³å°ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¯æŒå¤§æ–‡ä»¶ä¸‹è½½</span></span><br><span class="line">git lfs install</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½æ¨¡å‹ï¼Œçº¦7GBï¼Œä¸‹è½½æ¯”è¾ƒè€—æ—¶</span></span><br><span class="line">git clone --depth 1 https://huggingface.co/THUDM/chatglm-6b-int4</span><br></pre></td></tr></table></figure>

<p>å®‰è£…ä¾èµ–</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…ä¾èµ–ï¼Œä¾èµ–æºè‡ªChatGLM2-6B-int4 HF readme</span></span><br><span class="line">pip install protobuf transformers==4.30.2 cpm_kernels torch==2.0.1 gradio mdtex2html sentencepiece accelerate</span><br></pre></td></tr></table></figure>

<h3 id="Test-ChatGLM2"><a href="#Test-ChatGLM2" class="headerlink" title="Test ChatGLM2"></a>Test ChatGLM2</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer, AutoModel</span><br><span class="line"><span class="comment"># è¿™é‡Œå°†THUDM/chatglm2-6b-int4 æ›´æ¢ä¸ºåˆšæ¨¡å‹ä¸‹è½½å­˜æ”¾çš„è·¯å¾„ï¼Œ</span></span><br><span class="line"><span class="comment"># å¦åˆ™ä¼šè‡ªåŠ¨å»é‡æ–°ä¸‹è½½æ¨¡å‹åˆ°~/.cache/ç›®å½•ä¸‹</span></span><br><span class="line">tokenizer = AutoTokenizer.from_pretrained(<span class="string">&quot;THUDM/chatglm2-6b-int4&quot;</span>, trust_remote_code=<span class="literal">True</span>)</span><br><span class="line">model = AutoModel.from_pretrained(<span class="string">&quot;THUDM/chatglm2-6b-int4&quot;</span>, trust_remote_code=<span class="literal">True</span>).half().cuda()</span><br><span class="line">model = model.<span class="built_in">eval</span>()</span><br><span class="line">response, history = model.chat(tokenizer, <span class="string">&quot;ä½ å¥½&quot;</span>, history=[])</span><br><span class="line"><span class="built_in">print</span>(response)</span><br><span class="line"></span><br><span class="line">t = time.time()</span><br><span class="line">response, history = model.chat(tokenizer, <span class="string">&quot;æ™šä¸Šç¡ä¸ç€åº”è¯¥æ€ä¹ˆåŠ&quot;</span>, history=history)</span><br><span class="line"><span class="built_in">print</span>(response)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;coast:<span class="subst">&#123;time.time() - t:<span class="number">.4</span>f&#125;</span>s&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚</span><br><span class="line">ç¡çœ å¯¹èº«ä½“å¥åº·å’Œå¿ƒç†å¥åº·éå¸¸é‡è¦ã€‚å¦‚æœæ™šä¸Šç¡ä¸ç€ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹ä¸€äº›æ–¹æ³•:</span><br><span class="line"></span><br><span class="line">1. æ”¾æ¾è‡ªå·±:åœ¨ç¡è§‰å‰æ•°ç»µç¾Šæˆ–åšä¸€äº›è½»æ¾çš„ä¼¸å±•è¿åŠ¨ï¼Œå¯ä»¥å¸®åŠ©æ”¾æ¾è‡ªå·±ã€‚ä¹Ÿå¯ä»¥å°è¯•ä½¿ç”¨æ¸©å’Œçš„ç‘œä¼½æˆ–ä¼¸å±•ç»ƒä¹ ï¼Œç¼“è§£èº«ä½“çš„ç´§å¼ ã€‚</span><br><span class="line"></span><br><span class="line">2. åˆ›å»ºä¸€ä¸ªèˆ’é€‚çš„ç¡çœ ç¯å¢ƒ:ç¡®ä¿å§å®¤å®‰é™ã€é»‘æš—ã€å‡‰çˆ½å’Œèˆ’é€‚ã€‚å¦‚æœå§å®¤ä¸­å­˜åœ¨å™ªéŸ³æˆ–å¼ºå…‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è€³å¡æˆ–çœ¼ç½©ã€‚</span><br><span class="line"></span><br><span class="line">3. é¿å…ä½¿ç”¨ç”µå­äº§å“:åœ¨ç¡è§‰å‰ä¸€å°æ—¶é¿å…ä½¿ç”¨ç”µå­äº§å“ï¼Œå¦‚æ‰‹æœºã€ç”µè§†æˆ–ç”µè„‘ã€‚è¿™äº›è®¾å¤‡å‘å‡ºçš„è“å…‰ä¼šå½±å“ç¡çœ è´¨é‡ã€‚</span><br><span class="line"></span><br><span class="line">4. å»ºç«‹ä¸€ä¸ªå›ºå®šçš„ç¡çœ æ—¶é—´è¡¨:ä¿æŒå›ºå®šçš„ç¡çœ æ—¶é—´è¡¨å¯ä»¥å¸®åŠ©èº«ä½“å»ºç«‹ä¸€ä¸ªæ­£å¸¸çš„ç¡çœ èŠ‚å¾‹ã€‚å°½é‡åœ¨æ¯å¤©ç›¸åŒçš„æ—¶é—´ä¸ŠåºŠå’Œèµ·åºŠã€‚</span><br><span class="line"></span><br><span class="line">5. é¿å…é¥®ç”¨åˆºæ¿€æ€§é¥®æ–™:åœ¨ç¡è§‰å‰å‡ å°æ—¶é¿å…é¥®ç”¨å’–å•¡ã€èŒ¶ã€é…’æˆ–å«æœ‰å·§å…‹åŠ›ç­‰åˆºæ¿€æ€§é¥®æ–™ã€‚</span><br><span class="line"></span><br><span class="line">å¦‚æœè¿™äº›æ–¹æ³•æ— æ•ˆï¼Œå¯ä»¥è€ƒè™‘å’¨è¯¢åŒ»ç”Ÿä»¥äº†è§£å¯èƒ½çš„åŸå› ã€‚</span><br><span class="line">coast:12.4483s</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å°±ä½¿ç”¨å®˜æ–¹çš„æ ·ä¾‹ä»£ç ç®€å•çš„ä½¿ç”¨ChatGLMè¿›è¡Œæ¨ç†å¯¹è¯äº†ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬å¯ä»¥ç®€å•çš„å°è£…ä¸€ä¸‹ï¼Œæ›´ä¼˜ç¾åœ°ä½¿ç”¨ChatGLM2ï¼</p>
<h2 id="FastAPI-Deploy-ChatGLM2"><a href="#FastAPI-Deploy-ChatGLM2" class="headerlink" title="FastAPI Deploy ChatGLM2"></a>FastAPI Deploy ChatGLM2</h2><p>ä¸Šé¢æˆ‘ä»¬å·²ç»å­¦ä¼šäº†ä¸‹è½½æ¨¡å‹ï¼Œç„¶åè¿›è¡Œç®€å•çš„æ¨¡å‹å¯¹è¯æ¨ç†ã€‚æ¥ä¸‹æ¥ä½¿ç”¨æˆ‘ä»¬ä½¿ç”¨FastAPIå¯ä»¥å°†æ¨¡å‹éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šï¼Œä»¥æ¥å£æ–¹å¼è¿›è¡Œå¯¹è¯ã€‚æ³¨æ„è¿™é‡Œçš„APIä»…ä»…æ˜¯ç®€å•å°è£…ï¼Œä¸åŒäºFastChatç±»OpenAPIæä¾›çš„æ¥å£ã€‚</p>
<blockquote>
<p>FastAPI: <a class="link"   href="https://fastapi.tiangolo.com/" >https://fastapi.tiangolo.com/<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<p>ä»¥ä¸‹ä»£ç å·²ç»ä¸å¤ªè§„èŒƒï¼Œåªæ˜¯ä¸€ä¸ªæµå¼è°ƒç”¨ChatGLM2 APIçš„æ–¹å¼ï¼Œå»ºè®®ä½¿ç”¨ChatGLM2å®˜æ–¹æä¾›çš„æ ·ä¾‹ä»£ç éƒ¨ç½²æµ‹è¯•ï¼Œæˆ–è€…å¼åæ–‡çš„FastChatæ–¹å¼ï¼</p>
<blockquote>
<p>ChatGLM2-6B: <a class="link"   href="https://github.com/THUDM/ChatGLM2-6B" >https://github.com/THUDM/ChatGLM2-6B<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   href="https://github.com/THUDM/ChatGLM2-6B/blob/main/openai_api.py" >https://github.com/THUDM/ChatGLM2-6B/blob/main/openai_api.py<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">File Name:chatglm2-6b-stream-api.py</span></span><br><span class="line"><span class="string">Author:LongerKing</span></span><br><span class="line"><span class="string">Time:2023/8/15 13:33</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer, AutoModel</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.cors <span class="keyword">import</span> CORSMiddleware</span><br><span class="line"><span class="keyword">from</span> sse_starlette.sse <span class="keyword">import</span> ServerSentEvent, EventSourceResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getLogger</span>(<span class="params">name, file_name, use_formatter=<span class="literal">True</span></span>):</span><br><span class="line">    logger = logging.getLogger(name)</span><br><span class="line">    logger.setLevel(logging.INFO)</span><br><span class="line">    console_handler = logging.StreamHandler(sys.stdout)</span><br><span class="line">    formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s    %(message)s&#x27;</span>)</span><br><span class="line">    console_handler.setFormatter(formatter)</span><br><span class="line">    console_handler.setLevel(logging.INFO)</span><br><span class="line">    logger.addHandler(console_handler)</span><br><span class="line">    <span class="keyword">if</span> file_name:</span><br><span class="line">        handler = logging.FileHandler(file_name, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        handler.setLevel(logging.INFO)</span><br><span class="line">        <span class="keyword">if</span> use_formatter:</span><br><span class="line">            formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(message)s&#x27;</span>)</span><br><span class="line">            handler.setFormatter(formatter)</span><br><span class="line">        logger.addHandler(handler)</span><br><span class="line">    <span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logger = getLogger(<span class="string">&#x27;ChatGLM&#x27;</span>, <span class="string">&#x27;chatlog.log&#x27;</span>)</span><br><span class="line"></span><br><span class="line">MAX_HISTORY = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatGLM</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        logger.info(<span class="string">&quot;Start initialize model...&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.tokenizer = AutoTokenizer.from_pretrained(</span><br><span class="line">            <span class="string">&quot;/home/bigdata/wonders/wanglang/models/chatglm2-6b-cmeee_eie001&quot;</span>, trust_remote_code=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.model = AutoModel.from_pretrained(<span class="string">&quot;/home/bigdata/wonders/wanglang/models/chatglm2-6b-cmeee_eie001&quot;</span>,</span><br><span class="line">                                               trust_remote_code=<span class="literal">True</span>).quantize(<span class="number">8</span>).cuda()</span><br><span class="line">        <span class="variable language_">self</span>.model.<span class="built_in">eval</span>()</span><br><span class="line">        logger.info(<span class="string">&quot;Model initialization finished.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">            <span class="keyword">with</span> torch.cuda.device(<span class="string">f&quot;cuda:<span class="subst">&#123;args.device&#125;</span>&quot;</span>):</span><br><span class="line">                torch.cuda.empty_cache()</span><br><span class="line">                torch.cuda.ipc_collect()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">answer</span>(<span class="params">self, query: <span class="built_in">str</span>, history</span>):</span><br><span class="line">        response, history = <span class="variable language_">self</span>.model.chat(<span class="variable language_">self</span>.tokenizer, query, history=history)</span><br><span class="line">        history = [<span class="built_in">list</span>(h) <span class="keyword">for</span> h <span class="keyword">in</span> history]</span><br><span class="line">        <span class="keyword">return</span> response, history</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stream</span>(<span class="params">self, query, history</span>):</span><br><span class="line">        <span class="keyword">if</span> query <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> history <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">yield</span> &#123;<span class="string">&quot;query&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;response&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;history&quot;</span>: [], <span class="string">&quot;finished&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">        size = <span class="number">0</span></span><br><span class="line">        response = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> response, history <span class="keyword">in</span> <span class="variable language_">self</span>.model.stream_chat(<span class="variable language_">self</span>.tokenizer, query, history):</span><br><span class="line">            this_response = response[size:]</span><br><span class="line">            history = [<span class="built_in">list</span>(h) <span class="keyword">for</span> h <span class="keyword">in</span> history]</span><br><span class="line">            size = <span class="built_in">len</span>(response)</span><br><span class="line">            <span class="keyword">yield</span> &#123;<span class="string">&quot;delta&quot;</span>: this_response, <span class="string">&quot;response&quot;</span>: response, <span class="string">&quot;finished&quot;</span>: <span class="literal">False</span>&#125;</span><br><span class="line">        logger.info(<span class="string">&quot;Answer - &#123;&#125;&quot;</span>.<span class="built_in">format</span>(response))</span><br><span class="line">        <span class="keyword">yield</span> &#123;<span class="string">&quot;query&quot;</span>: query, <span class="string">&quot;delta&quot;</span>: <span class="string">&quot;[EOS]&quot;</span>, <span class="string">&quot;response&quot;</span>: response, <span class="string">&quot;history&quot;</span>: history, <span class="string">&quot;finished&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_server</span>(<span class="params">http_address: <span class="built_in">str</span>, port: <span class="built_in">int</span>, gpu_id: <span class="built_in">str</span></span>):</span><br><span class="line">    os.environ[<span class="string">&#x27;CUDA_DEVICE_ORDER&#x27;</span>] = <span class="string">&#x27;PCI_BUS_ID&#x27;</span></span><br><span class="line">    os.environ[<span class="string">&#x27;CUDA_VISIBLE_DEVICES&#x27;</span>] = gpu_id</span><br><span class="line"></span><br><span class="line">    bot = ChatGLM()</span><br><span class="line"></span><br><span class="line">    app = FastAPI()</span><br><span class="line">    app.add_middleware(CORSMiddleware,</span><br><span class="line">                       allow_origins=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">                       allow_credentials=<span class="literal">True</span>,</span><br><span class="line">                       allow_methods=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">                       allow_headers=[<span class="string">&quot;*&quot;</span>]</span><br><span class="line">                       )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;started&#x27;</span>, <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.post(<span class="params"><span class="string">&quot;/chat&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">answer_question</span>(<span class="params">arg_dict: <span class="built_in">dict</span></span>):</span><br><span class="line">        result = &#123;<span class="string">&quot;query&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;response&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            text = arg_dict[<span class="string">&quot;query&quot;</span>]</span><br><span class="line">            ori_history = arg_dict[<span class="string">&quot;history&quot;</span>]</span><br><span class="line">            logger.info(<span class="string">&quot;Query - &#123;&#125;&quot;</span>.<span class="built_in">format</span>(text))</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(ori_history) &gt; <span class="number">0</span>:</span><br><span class="line">                logger.info(<span class="string">&quot;History - &#123;&#125;&quot;</span>.<span class="built_in">format</span>(ori_history))</span><br><span class="line">            history = ori_history[-MAX_HISTORY:]</span><br><span class="line">            history = [<span class="built_in">tuple</span>(h) <span class="keyword">for</span> h <span class="keyword">in</span> history]</span><br><span class="line">            response, history = bot.answer(text, history)</span><br><span class="line">            logger.info(<span class="string">&quot;Answer - &#123;&#125;&quot;</span>.<span class="built_in">format</span>(response))</span><br><span class="line">            ori_history.append((text, response))</span><br><span class="line">            result = &#123;<span class="string">&quot;query&quot;</span>: text, <span class="string">&quot;response&quot;</span>: response,</span><br><span class="line">                      <span class="string">&quot;history&quot;</span>: ori_history, <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.post(<span class="params"><span class="string">&quot;/stream&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">answer_question_stream</span>(<span class="params">arg_dict: <span class="built_in">dict</span></span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">decorate</span>(<span class="params">generator</span>):</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> generator:</span><br><span class="line">                <span class="keyword">yield</span> ServerSentEvent(json.dumps(item, ensure_ascii=<span class="literal">False</span>), event=<span class="string">&#x27;delta&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            text = arg_dict[<span class="string">&quot;query&quot;</span>]</span><br><span class="line">            ori_history = arg_dict[<span class="string">&quot;history&quot;</span>]</span><br><span class="line">            logger.info(<span class="string">&quot;Query - &#123;&#125;&quot;</span>.<span class="built_in">format</span>(text))</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(ori_history) &gt; <span class="number">0</span>:</span><br><span class="line">                logger.info(<span class="string">&quot;History - &#123;&#125;&quot;</span>.<span class="built_in">format</span>(ori_history))</span><br><span class="line">            history = ori_history[-MAX_HISTORY:]</span><br><span class="line">            history = [<span class="built_in">tuple</span>(h) <span class="keyword">for</span> h <span class="keyword">in</span> history]</span><br><span class="line">            <span class="keyword">return</span> EventSourceResponse(decorate(bot.stream(text, history)))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> EventSourceResponse(decorate(bot.stream(<span class="literal">None</span>, <span class="literal">None</span>)))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.get(<span class="params"><span class="string">&quot;/free_gc&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">free_gpu_cache</span>():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            bot.clear()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>&#125;</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;starting server...&quot;</span>)</span><br><span class="line">    uvicorn.run(app=app, host=http_address, port=port, workers=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Stream API Service for ChatGLM2-6B&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--device&#x27;</span>, <span class="string">&#x27;-d&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;deviceï¼Œ-1 means cpu, other means gpu ids&#x27;</span>, default=<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--host&#x27;</span>, <span class="string">&#x27;-H&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;host to listen&#x27;</span>, default=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--port&#x27;</span>, <span class="string">&#x27;-P&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;port of this service&#x27;</span>, default=<span class="number">8000</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    start_server(args.host, <span class="built_in">int</span>(args.port), args.device)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>LLMs</category>
      </categories>
      <tags>
        <tag>LLMs</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/longerking-blogs/2022/10/25/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a class="link"   href="https://hexo.io/" >Hexo<i class="fas fa-external-link-alt"></i></a>! This is your very first post. Check <a class="link"   href="https://hexo.io/docs/" >documentation<i class="fas fa-external-link-alt"></i></a> for more info. If you get any problems when using Hexo, you can find the answer in <a class="link"   href="https://hexo.io/docs/troubleshooting.html" >troubleshooting<i class="fas fa-external-link-alt"></i></a> or you can ask me on <a class="link"   href="https://github.com/hexojs/hexo/issues" >GitHub<i class="fas fa-external-link-alt"></i></a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a class="link"   href="https://hexo.io/docs/writing.html" >Writing<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a class="link"   href="https://hexo.io/docs/server.html" >Server<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a class="link"   href="https://hexo.io/docs/generating.html" >Generating<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a class="link"   href="https://hexo.io/docs/one-command-deployment.html" >Deployment<i class="fas fa-external-link-alt"></i></a></p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>My Site GitHub Pages Starter</title>
    <url>/longerking-blogs/2023/07/16/my-site-starter/</url>
    <content><![CDATA[<h1 id="GitHub-Page-Starter"><a href="#GitHub-Page-Starter" class="headerlink" title="GitHub Page Starter"></a>GitHub Page Starter</h1><h2 id="1-Github-Pages"><a href="#1-Github-Pages" class="headerlink" title="1. Github Pages"></a>1. Github Pages</h2><p>Referencesï¼š<a class="link"   href="https://pages.github.com/" >GitHub Pages | Websites for you and your projects, hosted directly from your GitHub repository. Just edit, push, and your changes are live.<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="2-Hexo-Blogs"><a href="#2-Hexo-Blogs" class="headerlink" title="2. Hexo Blogs"></a>2. Hexo Blogs</h2><p>References:   </p>
<ol>
<li><p><a class="link"   href="https://zhuanlan.zhihu.com/p/26625249" >GitHub+Hexo æ­å»ºä¸ªäººç½‘ç«™è¯¦ç»†æ•™ç¨‹ - çŸ¥ä¹ (zhihu.com)<i class="fas fa-external-link-alt"></i></a></p>
</li>
<li><p><a class="link"   href="https://hexo.io/zh-cn/" >Hexo<i class="fas fa-external-link-alt"></i></a></p>
</li>
</ol>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŸºäºHexo-markdownçš„my-blogsåšå®¢é¡¹ç›®ï¼Œæ³¨æ„è¿™ä¸ªå¹¶ä¸æ˜¯github.io.ä»“åº“ã€‚</p>
<p>Note: æ³¨æ„è¿™é‡Œä¹Ÿå¯ä»¥ä¸‹è½½ç”±KeepThemeæä¾›çš„æ¨¡æ¿å·¥ç¨‹ä»£æ›¿my-blogsé¡¹ç›®ï¼š<a class="link"   href="https://keep-docs.xpoet.cn/tutorial/get-start/quick-starter.html" >Keep ä¸»é¢˜å¿«é€Ÿå¯åŠ¨æ¨¡æ¿ | Keep ä¸»é¢˜ä½¿ç”¨æŒ‡å— (xpoet.cn)<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br><span class="line">hexo init my-blogs</span><br><span class="line">cd my-blogs</span><br><span class="line">npm install</span><br><span class="line">hexo server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å»ºè®®é‡‡ç”¨ä¸‹è½½æ¨¡æ¿çš„æ–¹å¼</span></span><br><span class="line">mv hexo-theme-keep-starter-main my-blogs</span><br><span class="line">cd my-blogs</span><br><span class="line">git init</span><br><span class="line">git branch -M main</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<h2 id="3-Hexo-theme"><a href="#3-Hexo-theme" class="headerlink" title="3. Hexo theme"></a>3. Hexo theme</h2><blockquote>
<p>Reference</p>
<ol>
<li><p><a class="link"   href="https://hexo.io/themes/" >Themes | Hexo<i class="fas fa-external-link-alt"></i></a></p>
</li>
<li><p><a class="link"   href="https://keep-docs.xpoet.cn/" >Keep ä¸»é¢˜ä½¿ç”¨æŒ‡å— | Hexo ä¸»é¢˜ Keep å®˜æ–¹æ–‡æ¡£ (xpoet.cn)<i class="fas fa-external-link-alt"></i></a></p>
</li>
</ol>
</blockquote>
<h2 id="4-manually-push-to-GitHub-io-pages"><a href="#4-manually-push-to-GitHub-io-pages" class="headerlink" title="4. manually push to GitHub io pages"></a>4. manually push to GitHub io pages</h2><p>GitHub: create empty repository  username.github.io</p>
<p>Install plugin <code>hexo-deployer-git</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<p>æ‰¾åˆ°<code>_config.yml</code>æ–‡ä»¶ï¼Œæ‰¾åˆ°<code>deploy</code>ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¿›è¡Œä¿®æ”¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ³¨æ„å…ˆç»™Githubé…ç½®æœ¬æœºçš„ssh-key æ‰èƒ½éƒ¨ç½²åˆ°Github</span></span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https://github.com:ä½ çš„ç”¨æˆ·å/ä½ çš„ç”¨æˆ·å.github.io.git</span><br><span class="line">  branch: main</span><br></pre></td></tr></table></figure>

<p>æ‰‹åŠ¨æ„å»ºé¡¹ç›®ç”Ÿæˆé™æ€é¡µé¢å’Œéƒ¨ç½²åˆ°GitHub</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo clean  # æ¸…é™¤ç¼“å­˜</span><br><span class="line">hexo g      # ç”Ÿæˆé™æ€ç½‘é¡µ</span><br><span class="line">hexo d      # éƒ¨ç½²åˆ°Github</span><br></pre></td></tr></table></figure>

<h2 id="5-Suggest-Auto-push-to-GitHub-pages-by-GitHub-Actions"><a href="#5-Suggest-Auto-push-to-GitHub-pages-by-GitHub-Actions" class="headerlink" title="5. Suggest Auto push to GitHub pages by GitHub Actions"></a>5. Suggest Auto push to GitHub pages by GitHub Actions</h2><p>ä½¿ç”¨è¿™ä¸ªä»£æ›¿ä¸Šé¢çš„æ‰‹åŠ¨å‘å¸ƒï¼Œç§æœ‰æºç åº“åˆ›å»ºåˆ°my-blogsï¼Œå…¬å¼€åº“åˆ›å»ºåˆ°username.github.ioã€‚</p>
<p>å‚ç…§ä¸‹é¢çš„é“¾æ¥æ–‡æ¡£</p>
<blockquote>
<p><a class="link"   href="https://juejin.cn/post/6943895271751286821" >å¦‚ä½•ä½¿ç”¨ GitHub Actions è‡ªåŠ¨éƒ¨ç½² Hexo åšå®¢ - æ˜é‡‘ (juejin.cn)<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<h2 id="6-create-a-menu-page"><a href="#6-create-a-menu-page" class="headerlink" title="6.create a menu page"></a>6.create a menu page</h2><p>update keep.yml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">menu:</span><br><span class="line">  Home: /</span><br><span class="line">  Archives: /archives</span><br><span class="line">  Tags: /tags</span><br><span class="line">  Categories: /categories</span><br><span class="line">  # Links: /links</span><br><span class="line">  About: /about</span><br><span class="line">  # Changelog: /changelog</span><br><span class="line">  # ......</span><br></pre></td></tr></table></figure>

<p>create menu about page and edit about</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo new page about</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>create new page</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo new my-site-starter</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>è¿›ç¨‹é—´é€šä¿¡-å…±äº«å†…å­˜</title>
    <url>/longerking-blogs/2024/09/19/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/</url>
    <content><![CDATA[<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨å…±äº«å†…å­˜"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨å…±äº«å†…å­˜" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨å…±äº«å†…å­˜"></a>ä¸ºä»€ä¹ˆä½¿ç”¨å…±äº«å†…å­˜</h2><p>å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸å¤šä¸ªè¿›ç¨‹æˆ–è€…ç°æˆè®¿é—®åŒä¸€å—<strong>å†…å­˜ç©ºé—´</strong>ï¼Œè¿™æ ·å¯ä»¥å¿«é€Ÿçš„äº¤æ¢æ•°æ®å’Œæ¶ˆæ¯ã€‚</p>
<p>ä½¿ç”¨å…±äº«å†…å­˜çš„åŸå› ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li><strong>é«˜æ€§èƒ½çš„æ•°æ®äº¤æ¢</strong>ï¼šå…±äº«å†…å­˜é€šå¸¸æ¯”å…¶ä»–é€šä¿¡æœºåˆ¶ï¼ˆå¦‚ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€Socketç­‰ï¼‰æ›´å¿«ï¼Œå› ä¸ºå®ƒå‡å°‘äº†æ•°æ®å¤åˆ¶çš„æ¬¡æ•°ã€‚åœ¨å…±äº«å†…å­˜ä¸­ï¼Œæ•°æ®åªéœ€å†™å…¥ä¸€æ¬¡ï¼Œå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹ç›´æ¥è®¿é—®ã€‚</li>
<li><strong>åŒæ­¥æœºåˆ¶</strong>ï¼šå…±äº«å†…å­˜é€šå¸¸ä¸åŒæ­¥åŸè¯­ï¼ˆå¦‚äº’æ–¥é”ã€ä¿¡å·é‡ç­‰ï¼‰ç»“åˆä½¿ç”¨ï¼Œä»¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚</li>
<li><strong>æ–¹ä¾¿çš„æ•°æ®å…±äº«</strong>ï¼šåœ¨å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹åº”ç”¨ä¸­ï¼Œå…±äº«å†…å­˜æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥å…±äº«å¤§é‡æ•°æ®ï¼Œæ— éœ€é€šè¿‡ç¹ççš„æ•°æ®ä¼ é€’è¿‡ç¨‹ã€‚</li>
<li><strong>å‡å°‘èµ„æºæ¶ˆè€—</strong>ï¼šä½¿ç”¨å…±äº«å†…å­˜å¯ä»¥å‡å°‘ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä¸éœ€è¦åƒå…¶ä»–é€šä¿¡æœºåˆ¶é‚£æ ·è¿›è¡Œæ•°æ®çš„å¤šæ¬¡å¤åˆ¶ã€‚</li>
</ol>
<p>åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œä½¿ç”¨å…±äº«å†…å­˜çš„åŸå› ä¸åœ¨é€šç”¨è®¡ç®—ç¯å¢ƒä¸­ä½¿ç”¨å…±äº«å†…å­˜çš„åŸå› ç±»ä¼¼ï¼Œä½†ä¹Ÿå…·æœ‰ä¸€äº›ç‰¹å®šçš„è€ƒè™‘å› ç´ ã€‚ä»¥ä¸‹æ˜¯åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ä½¿ç”¨å…±äº«å†…å­˜çš„å‡ ä¸ªä¸»è¦åŸå› ï¼š</p>
<ol>
<li><strong>èµ„æºé™åˆ¶</strong>ï¼šåµŒå…¥å¼ç³»ç»Ÿé€šå¸¸å…·æœ‰æœ‰é™çš„èµ„æºï¼ŒåŒ…æ‹¬å†…å­˜ã€å¤„ç†èƒ½åŠ›å’ŒåŠŸè€—ã€‚å…±äº«å†…å­˜å¯ä»¥å‡å°‘å†…å­˜å ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸å¤šä¸ªç»„ä»¶æˆ–ä»»åŠ¡å…±äº«ç›¸åŒçš„æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¸ºæ¯ä¸ªç»„ä»¶æˆ–ä»»åŠ¡å¤åˆ¶æ•°æ®ã€‚</li>
<li><strong>æ€§èƒ½è¦æ±‚</strong>ï¼šåµŒå…¥å¼ç³»ç»Ÿç»å¸¸éœ€è¦åœ¨ä¸¥æ ¼çš„å®æ—¶æ€§èƒ½è¦æ±‚ä¸‹è¿è¡Œã€‚å…±äº«å†…å­˜æä¾›äº†å¿«é€Ÿçš„é€šä¿¡æœºåˆ¶ï¼Œå¯ä»¥å‡å°‘æ•°æ®ä¼ è¾“å»¶è¿Ÿï¼Œè¿™å¯¹äºæ»¡è¶³å®æ—¶æ€§è¦æ±‚è‡³å…³é‡è¦ã€‚</li>
<li><strong>ä½åŠŸè€—</strong>ï¼šé€šè¿‡å‡å°‘æ•°æ®ä¼ è¾“å’Œå¤åˆ¶ï¼Œå…±äº«å†…å­˜æœ‰åŠ©äºé™ä½åŠŸè€—ï¼Œè¿™å¯¹äºç”µæ± ä¾›ç”µçš„åµŒå…¥å¼è®¾å¤‡æ¥è¯´å°¤ä¸ºé‡è¦ã€‚</li>
<li><strong>ç®€åŒ–è®¾è®¡</strong>ï¼šå…±äº«å†…å­˜å¯ä»¥ç®€åŒ–ç³»ç»Ÿè®¾è®¡ï¼Œå› ä¸ºå®ƒå‡å°‘äº†éœ€è¦ç®¡ç†çš„é€šä¿¡æ¥å£æ•°é‡ã€‚è¿™å¯¹äºå‡å°‘ç¡¬ä»¶å¤æ‚æ€§å’Œé™ä½æˆæœ¬éå¸¸æœ‰ç”¨ã€‚</li>
<li><strong>é€šä¿¡æ•ˆç‡</strong>ï¼šåœ¨å¤šå¤„ç†å™¨æˆ–å¤šæ ¸åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œå…±äº«å†…å­˜å¯ä»¥æä¾›é«˜æ•ˆçš„å¤„ç†å™¨é—´é€šä¿¡ï¼Œè¿™å¯¹äºå¹¶è¡Œå¤„ç†å’Œä»»åŠ¡åˆ†é…éå¸¸é‡è¦ã€‚</li>
</ol>
<pre class="mermaid">graph LR
	è¿›ç¨‹A <--> å…±äº«å†…å­˜ <--> è¿›ç¨‹B
	è¿›ç¨‹C <--> å…±äº«å†…å­˜ <--> è¿›ç¨‹...</pre>



<h2 id="å…±äº«å†…å­˜çš„åº”ç”¨"><a href="#å…±äº«å†…å­˜çš„åº”ç”¨" class="headerlink" title="å…±äº«å†…å­˜çš„åº”ç”¨"></a>å…±äº«å†…å­˜çš„åº”ç”¨</h2><p>å…±äº«å†…å­˜å‡½æ•°ç”±shmgetã€shmatã€shmdtã€shmctlå››ä¸ªå‡½æ•°ç»„æˆã€‚</p>
<h3 id="å‡½æ•°åŸå‹"><a href="#å‡½æ•°åŸå‹" class="headerlink" title="å‡½æ•°åŸå‹"></a>å‡½æ•°åŸå‹</h3><p>shmget(å¾—åˆ°ä¸€ä¸ªå…±äº«å†…å­˜æ ‡è¯†ç¬¦æˆ–åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜å¯¹è±¡)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŠŠä»pathname(å·²å­˜åœ¨çš„è·¯å¾„)å¯¼å‡ºçš„ä¿¡æ¯ä¸idçš„ä½åº8ä½ç»„åˆæˆç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°IPCé”®ï¼Œç”¨æˆ·è¿›ç¨‹é—´é€šä¿¡</span></span><br><span class="line"><span class="comment"> * __pathname: æŒ‡å®šçš„æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶å¿…é¡»å­˜åœ¨ä¸”å¯å­˜å–</span></span><br><span class="line"><span class="comment"> * __proj_id:  è®¡åˆ’ä»£å·ï¼ˆproject IDï¼‰ï¼Œè¿™é‡Œå¯ä»¥è¡¨ç¤ºä¸ºæŒ‡å®šå…±äº«å†…å­˜å˜é‡çš„Idï¼Œï¼ˆ0-255ï¼‰</span></span><br><span class="line"><span class="comment"> * key_tä¸€èˆ¬ä¸º32ä½çš„intå‹çš„IPCé”®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">key_t</span> <span class="title function_">ftok</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *__pathname, <span class="type">int</span> __proj_id)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å¾—åˆ°ä¸€ä¸ªå…±äº«å†…å­˜æ ‡è¯†ç¬¦æˆ–åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜å¯¹è±¡å¹¶è¿”å›å…±äº«å†…å­˜æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">* key:  0(IPC_PRIVATE)ï¼šä¼šå»ºç«‹æ–°å…±äº«å†…å­˜å¯¹è±¡</span></span><br><span class="line"><span class="comment">*       å¤§äº0çš„32ä½æ•´æ•°ï¼šè§†å‚æ•°shmflgæ¥ç¡®å®šæ“ä½œã€‚é€šå¸¸è¦æ±‚æ­¤å€¼æ¥æºäºftokè¿”å›çš„IPCé”®å€¼</span></span><br><span class="line"><span class="comment">* size: å¤§äº0çš„æ•´æ•°ï¼šæ–°å»ºçš„å…±äº«å†…å­˜å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½, </span></span><br><span class="line"><span class="comment">* 		0ï¼šåªè·å–å…±äº«å†…å­˜æ—¶æŒ‡å®šä¸º0</span></span><br><span class="line"><span class="comment">* shmflg: 0ï¼šå–å…±äº«å†…å­˜æ ‡è¯†ç¬¦ï¼Œè‹¥ä¸å­˜åœ¨åˆ™å‡½æ•°ä¼šæŠ¥é”™</span></span><br><span class="line"><span class="comment">* 		  IPC_CREATï¼šå½“shmflg&amp;IPC_CREATä¸ºçœŸæ—¶ï¼Œå¦‚æœå†…æ ¸ä¸­ä¸å­˜åœ¨é”®å€¼ä¸keyç›¸ç­‰çš„å…±äº«å†…å­˜ï¼Œåˆ™æ–°å»ºä¸€ä¸ªå…±äº«å†…å­˜ï¼›å¦‚æœå­˜åœ¨è¿™æ ·çš„å…±äº«å†…å­˜ï¼Œè¿”å›æ­¤å…±äº«å†…å­˜çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">* 		  IPC_CREAT|IPC_EXCLï¼šå¦‚æœå†…æ ¸ä¸­ä¸å­˜åœ¨é”®å€¼ä¸keyç›¸ç­‰çš„å…±äº«å†…å­˜ï¼Œåˆ™æ–°å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼›å¦‚æœå­˜åœ¨è¿™æ ·çš„å…±äº«å†…å­˜åˆ™æŠ¥é”™</span></span><br><span class="line"><span class="comment">*         shmflgå‚æ•°ä¸ºæ¨¡å¼æ ‡å¿—å‚æ•°ï¼Œä½¿ç”¨æ—¶éœ€è¦ä¸IPCå¯¹è±¡å­˜å–æƒé™ï¼ˆå¦‚0600ï¼‰è¿›è¡Œ|è¿ç®—æ¥ç¡®å®šä¿¡å·é‡é›†çš„å­˜å–æƒé™</span></span><br><span class="line"><span class="comment">* return æˆåŠŸï¼šè¿”å›å…±äº«å†…å­˜çš„æ ‡è¯†ç¬¦ å‡ºé”™ï¼š-1ï¼Œé”™è¯¯åŸå› å­˜äºerrorä¸­</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">shmget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">size_t</span> size, <span class="type">int</span> shmflg)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* è¿æ¥å…±äº«å†…å­˜, è¿æ¥å…±äº«å†…å­˜æ ‡è¯†ç¬¦ä¸ºshmidçš„å…±äº«å†…å­˜ï¼Œè¿æ¥æˆåŠŸåæŠŠå…±äº«å†…å­˜åŒºå¯¹è±¡æ˜ å°„åˆ°è°ƒç”¨è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œéšåå¯åƒæœ¬åœ°ç©ºé—´ä¸€æ ·è®¿é—®</span></span><br><span class="line"><span class="comment">* __shmid: å…±äº«å†…å­˜æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">* *__shmaddr: æŒ‡å®šå…±äº«å†…å­˜å‡ºç°åœ¨è¿›ç¨‹å†…å­˜åœ°å€çš„ä»€ä¹ˆä½ç½®ï¼Œç›´æ¥æŒ‡å®šä¸ºNULLè®©å†…æ ¸è‡ªå·±å†³å®šä¸€ä¸ªåˆé€‚çš„åœ°å€ä½ç½®</span></span><br><span class="line"><span class="comment">* shmflg: SHM_RDONLYï¼šä¸ºåªè¯»æ¨¡å¼  </span></span><br><span class="line"><span class="comment">* 		  0: è¡¨ç¤ºé»˜è®¤è¡Œä¸ºï¼Œè¯»å†™æƒé™</span></span><br><span class="line"><span class="comment">*         SHM_RND: å¦‚æœè®¾ç½®äº†æ­¤æ ‡è¯†ï¼Œå¹¶ä¸”shmaddréƒ¨ä½NULLï¼Œå…±äº«å†…å­˜é™„åŠ åœ°å€ä¼šå‘ä¸‹èˆå…¥åˆ°SHMLBAä¸­</span></span><br><span class="line"><span class="comment">* return æˆåŠŸ è¿”å› å…±äº«å†…å­˜æ®µé™„åŠ åœ¨è¿›ç¨‹åœ°å€ç©ºé—´çš„åœ°å€ï¼Œå³è¿›ç¨‹ä¸­ä½¿ç”¨çš„å…±äº«å˜é‡åœ°å€</span></span><br><span class="line"><span class="comment">*        å¤±è´¥ è¿”å› (void *)-1 ï¼Œå¹¶è®¾ç½®errnoé”™è¯¯å€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">shmat</span><span class="params">(<span class="type">int</span> __shmid, <span class="type">const</span> <span class="type">void</span> *__shmaddr, <span class="type">int</span> __shmflg)</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ–­å¼€å…±äº«å†…å­˜è¿æ¥</span></span><br><span class="line"><span class="comment">* __shmaddr: è¿æ¥çš„å…±äº«å†…å­˜çš„èµ·å§‹åœ°å€, è¿›ç¨‹å†…éƒ¨è®¿é—®çš„å…±äº«å†…å­˜å˜é‡åœ°å€</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">shmdt</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *__shmaddr)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å…±äº«å†…å­˜ç®¡ç†ï¼Œå…±äº«å†…å­˜çš„æ§åˆ¶ï¼Œ å¦‚åˆ é™¤é‡ç½®ç­‰ã€‚æ²¡æœ‰æ‰§è¡Œï¼Œåˆ™å…±äº«å†…å­˜æœ€åçŠ¶æ€ä¼šä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œå³ä½¿ç¨‹åºç»“æŸäº†ï¼Œä¹Ÿä¼šä¿å­˜ã€‚</span></span><br><span class="line"><span class="comment">* ä¸å¸¸ç”¨ï¼Œåº”ä¸ºå¤šä¸ªè¿›ç¨‹ä¸­ï¼Œè¿™é‡Œåˆ é™¤äº†ï¼Œå…¶ä»–è¿›ç¨‹æ— æ³•è®¿é—®äº†ã€‚å¯ä»¥é€šè¿‡IPC_STATæ¥åˆ¤æ–­æœ€åä¸€æ¬¡é™„åŠ shmatå…±äº«å†…å­˜çš„æ—¶é—´,ä»¥åŠæ–­å¼€åˆ†ç¦»</span></span><br><span class="line"><span class="comment">* shmdtå…±äº«å†…å­˜çš„æ—¶é—´æ¥åˆ¤æ–­æ˜¯å¦åˆ é™¤ç­‰ã€‚ä»¥åŠè·å–æœ‰å¤šå°‘ä¸ªè¿›ç¨‹æ“ä½œå…±äº«å†…å­˜ã€‚</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* shmid:</span></span><br><span class="line"><span class="comment">* cmd: IPC_STATï¼šå¾—åˆ°å…±äº«å†…å­˜çš„çŠ¶æ€ï¼ŒæŠŠå…±äº«å†…å­˜çš„shmid_dsç»“æ„å¤åˆ¶åˆ°bufä¸­</span></span><br><span class="line"><span class="comment">* cmd: IPC_SETï¼šæ”¹å˜å…±äº«å†…å­˜çš„çŠ¶æ€ï¼ŒæŠŠbufæ‰€æŒ‡çš„shmid_dsç»“æ„ä¸­çš„uidã€gidã€modeå¤åˆ¶åˆ°å…±äº«å†…å­˜çš„shmid_dsç»“æ„å†…</span></span><br><span class="line"><span class="comment">* cmd: IPC_RMIDï¼šåˆ é™¤è¿™ç‰‡å…±äº«å†…å­˜</span></span><br><span class="line"><span class="comment">* buf: å…±äº«å†…å­˜ç®¡ç†ç»“æ„ä½“ã€‚å…·ä½“è¯´æ˜å‚è§å…±äº«å†…å­˜å†…æ ¸ç»“æ„å®šä¹‰éƒ¨åˆ†</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">shmctl</span><span class="params">(<span class="type">int</span> shmid, <span class="type">int</span> cmd, <span class="keyword">struct</span> shmid_ds *buf)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>åˆ›å»ºä¸¤ä¸ªCç¨‹åºï¼Œprocess_a.c  å’Œ process_b.cã€‚  ä¸¤ä¸ªç¨‹åºè®¿é—®åŒä¸€ä¸ªå†…å­˜å˜é‡ï¼Œä½¿ç”¨ftokæ“ä½œåŒä¸€ä¸ªå¯è®¿é—®çš„pathnameæ–‡ä»¶è·¯å¾„å’ŒåŒä¸€ä¸ªproj_idæ ‡è¯†ï¼Œ å¯ä»¥ä½¿ç”¨ä¸åŒçš„pathnameå’Œä¸åŒçš„proj_idæ¥æ ‡è¯†ä¸åŒçš„æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹ä¸Šçš„ä¸åŒIPCæ ‡è¯†ã€‚<br>å…¶ä¸­process_aç¨‹åºï¼Œæ›´æ–°å†™å…¥ IPC shmKeyä¸º(process_a, 65)çš„å†…å­˜å˜é‡ï¼Œè€Œprocess_bç¨‹åºï¼Œè¯»å–shmKeyåŒæ ·ä¸º(process_a, 65)çš„å†…å­˜å˜é‡ã€‚</p>
<p>process_a.c æ–‡ä»¶ï¼Œç¼–è¯‘gcc .&#x2F;process_a.c -o process_a</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * process_a æ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHM_SIZE 1024  <span class="comment">// å®šä¹‰å…±äº«å†…å­˜å¤§å°</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">key_t</span> key = ftok(<span class="string">&quot;process_a&quot;</span>, <span class="number">65</span>);  <span class="comment">// åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é”®  proj_id èŒƒå›´ ï¼ˆ0-256)  ä½8ä½ ç»„åˆä¸ºIPCé”®å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// key_t key = ftok(&quot;process_a&quot;, 257);  // åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é”®   257 = 0x101  1=0x01    ï¼Œ  ç­‰ä»·äº &lt;==&gt;  key_t shmKey = ftok(&quot;process_a&quot;, 1);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> shmid = shmget(key, SHM_SIZE, IPC_CREAT|<span class="number">0600</span>);   <span class="comment">// åˆ›å»ºå…±äº«å†…å­˜, å†…å­˜é•¿åº¦ä¸ºSHM_SIZE</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *shm_value1 = (<span class="type">char</span> *) shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>); <span class="comment">// è¿æ¥å…±äº«å†…å­˜   char ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// int *shm_value2 = (int *) shmat(shmid, (void*)0, 0); // è¿æ¥å…±äº«å†…å­˜ int ç±»å‹   void*æŒ‡é’ˆï¼Œå¯ä»¥ä»»æ„è½¬æ¢ç±»å‹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;<span class="number">10</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;process_a now set shm_value1 to [shm_value1=%d]\n&quot;</span>, i);</span><br><span class="line">        <span class="built_in">sprintf</span>(shm_value1, <span class="string">&quot;shm_value1=%d&quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// *shm_value2 = 10*i;   // intç±»å‹çš„ç›´æ¥èµ‹å€¼å³å¯ï¼Œä¸éœ€è¦ä½¿ç”¨sprintfè¿›è¡Œæ‹·è´</span></span><br><span class="line">        i++;</span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–­å¼€å…±äº«å†…å­˜è¿æ¥</span></span><br><span class="line">    shmdt(shm_value1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>process_b.c æ–‡ä»¶  ç¼–è¯‘ </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * process_b æ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHM_SIZE 1024  <span class="comment">// å®šä¹‰å…±äº«å†…å­˜å¤§å°</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// éœ€è¦å’Œprocess_aä¸­ï¼Œæ˜¯åŒæ ·çš„pathname å’Œ proj_id ,æ‰èƒ½è®¿é—®åˆ°åŒä¸€ä¸ª__pathname, å’Œ proj_idæ ‡è¯†çš„å†…å­˜å˜é‡å†…å­˜å˜é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="type">key_t</span> shmKey = ftok(<span class="string">&quot;process_a&quot;</span>, <span class="number">65</span>);  <span class="comment">// åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é”®  65</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// key_t shmKey = ftok(&quot;process_a&quot;, 1);  // åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é”®  1</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == shmKey) &#123;</span><br><span class="line">        perror(<span class="string">&quot;è·å–65çš„shmKeyå¼‚å¸¸&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> shmid = shmget(shmKey, SHM_SIZE, IPC_CREAT|<span class="number">0600</span>);   <span class="comment">// åˆ›å»ºå…±äº«å†…å­˜, å†…å­˜é•¿åº¦ä¸ºSHM_SIZE</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *shm_value1 = (<span class="type">char</span> *) shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>); <span class="comment">// è¿æ¥å…±äº«å†…å­˜   char ç±»å‹</span></span><br><span class="line">    <span class="comment">// char *shm_value1 = (char *) shmat(shmid, NULL, SHM_RDONLY); // è¿æ¥å…±äº«å†…å­˜   char ç±»å‹  SHM_RDONLY åªè¯»è¿æ¥ï¼Œæ— æ³•ä¿®æ”¹</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// int *shm_value1 = (int *) shmat(shmid, (void*)0, 0); // è¿æ¥å…±äº«å†…å­˜ int ç±»å‹   void*æŒ‡é’ˆï¼Œå¯ä»¥ä»»æ„è½¬æ¢ç±»å‹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;<span class="number">10</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰è¿›è¡Œä¸Šé¢çš„å®šä¹‰</span></span><br><span class="line">        <span class="comment">// sprintf(shm_value1, &quot;new set shm_value1 to %d&quot;, i);</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;process_b read: %s\n&quot;</span>, shm_value1);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–­å¼€å…±äº«å†…å­˜è¿æ¥</span></span><br><span class="line">    shmdt(shm_value1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å¼€ä¸¤ä¸ªç»ˆç«¯åˆ†åˆ«è¿è¡Œä¸¤ä¸ªç¨‹åºï¼Œä¸¤ä¸ªç¨‹åºéƒ½è°å…ˆè¿è¡Œéƒ½å¯ä»¥ï¼Œå› ä¸ºéƒ½ä½¿ç”¨äº†ftokå’Œshmgetåˆ›å»ºäº†æŒ‡å®šçš„å…±äº«å†…å­˜ï¼Œä¸ä¼šé‡å¤åˆ›å»ºã€‚</p>
<p>è¿è¡Œprocess_aï¼Œå†™å…¥å…±äº«å†…å­˜ï¼Œ3ç§’æ›´æ–°å†™ä¸€æ¬¡ï¼›è¿è¡Œprocess_bï¼Œè¯»å–å…±äº«å†…å­˜ï¼Œ1ç§’è¯»ä¸€æ¬¡</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">keyinwang@WondersWL:~/Projects/DemoC/shared_mem$ ./process_a </span><br><span class="line">process_a now set shm_value1 to [shm_value1=0]</span><br><span class="line">process_a now set shm_value1 to [shm_value1=1]</span><br><span class="line">process_a now set shm_value1 to [shm_value1=2]</span><br><span class="line">process_a now set shm_value1 to [shm_value1=3]</span><br><span class="line">process_a now set shm_value1 to [shm_value1=4]</span><br><span class="line">process_a now set shm_value1 to [shm_value1=5]</span><br><span class="line"></span><br><span class="line">// ......</span><br><span class="line">keyinwang@WondersWL:~/Projects/DemoC/shared_mem$ ./process_b </span><br><span class="line">process_b read: shm_value1=1</span><br><span class="line">process_b read: shm_value1=1</span><br><span class="line">process_b read: shm_value1=2</span><br><span class="line">process_b read: shm_value1=2</span><br><span class="line">process_b read: shm_value1=2</span><br><span class="line">process_b read: shm_value1=3</span><br></pre></td></tr></table></figure>



<p>æ³¨æ„å½“process_aä¸­é€”ç»“æŸæˆ–è€…ç»“æŸè¿è¡Œæ—¶ï¼Œå†æ¬¡è¿è¡Œprocess_bæ—¶ï¼Œå‘ç°å…±äº«å†…å­˜æ˜¯æœ€åæ”¹åŠ¨çš„å€¼ï¼Œè€Œä¸æ˜¯ç©ºå€¼ï¼Œè¯´æ˜å³ä½¿ç¨‹åºç»“æŸè¿è¡Œï¼Œè€Œå…±äº«å†…å­˜ä¾ç„¶å­˜åœ¨ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨shmctlåˆ é™¤å…±äº«å†…å­˜ã€‚å› æ­¤å°±ä¸€ç›´ä¿ç•™åœ¨å†…å­˜æŒ‡å®šåœ°å€ä¸­ã€‚</p>
<h3 id="æç¤º"><a href="#æç¤º" class="headerlink" title="æç¤º"></a>æç¤º</h3><p>ä¸ºäº†æä¾›å…±äº«å†…å­˜çš„å¯è¯»æ€§å’Œå¤ç”¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†pathnameèŠ‚ç‚¹å’Œproj_id æŠ½è±¡æå–å‡ºæ¥è¡¨ç¤ºä¸é€šçš„å…±äº«å†…å­˜å˜é‡ï¼Œå¹¶å¯ä»¥è®¾ç½®ä¸é€šå˜é‡çš„æŒ‡å®šshmSizeã€‚</p>
<p>å¦‚å¯ä»¥å®šä¹‰ä¸€ä¸ªå¤´æ–‡ä»¶shm_util.h</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// shm_util.h å®šä¹‰å„ä¸ªè¿›ç¨‹ä¹‹å‰çš„å…±äº«å†…å­˜å‚æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * shm_device_status:  è¿è¡ŒçŠ¶æ€  int *shm_device_status</span></span><br><span class="line"><span class="comment"> * 0ï¼šå·²å¼€æœº</span></span><br><span class="line"><span class="comment"> * 1ï¼šå¼€æœºä¸­</span></span><br><span class="line"><span class="comment"> * 2ï¼šå¼€æœºæˆåŠŸ</span></span><br><span class="line"><span class="comment"> * 3ï¼šå…³æœºä¸­</span></span><br><span class="line"><span class="comment"> * 4ï¼šé‡å¯ä¸­</span></span><br><span class="line"><span class="comment"> * 5ï¼šå‡çº§ä¸­</span></span><br><span class="line"><span class="comment"> * -1ï¼šè¿è¡Œå‡ºé”™ </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHMID_DEVICE_STATUS 1    <span class="comment">// proj_id = 1è¡¨ç¤º  device_status çš„å†…å­˜å˜é‡shm_device_statusï¼Œå®šä¹‰å€¼ä¿å­˜äº†intç±»å‹çš„ï¼Œç”¨æ¥è¡¨ç¤ºè®¾å¤‡ä¸é€šæ—¶æœŸçš„çŠ¶æ€ï¼Œéœ€è¦å…±äº«ç»™å…¶ä»–ç¨‹åºã€‚</span></span></span><br><span class="line"><span class="comment">/**å®šä¹‰statuså…±äº«å†…å­˜é•¿åº¦ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHMSIZE_STATUS 8    <span class="comment">// è¿™é‡Œå®šä¹‰ shmsize_status </span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** pathname */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHMPATHNAME_PROCESS <span class="string">&quot;/home/keyinwang/Projects/DemoC/shared_mem/process_c&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * shm_battery_voltage:  ç”µæ± ç”µå‹  char *shm_device_status</span></span><br><span class="line"><span class="comment"> * float è½¬ chat []   å¦‚ 5.000   4.890    å•ä½V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHMID_BATTERY_VOLTAGE 2</span></span><br><span class="line"><span class="comment">/**å®šä¹‰statuså…±äº«å†…å­˜é•¿åº¦ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHMSIZE_VOL 6    <span class="comment">// è¿™é‡Œå®šä¹‰ shmsize_vol</span></span></span><br></pre></td></tr></table></figure>

<p>å…±äº«å†…å­˜å†™è¿›ç¨‹process_c.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * process_c æ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**å¼•å…¥å…¬å…±å®šä¹‰å¥½çš„å…±äº«å˜é‡å‚æ•° */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;shm_util.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€ä¸ªå…±äº«å˜é‡</span></span><br><span class="line">    <span class="type">key_t</span> shmKey = ftok(SHMPATHNAME_PROCESS, SHMID_DEVICE_STATUS);  <span class="comment">// åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é”®</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == shmKey) &#123;</span><br><span class="line">        perror(<span class="string">&quot;è·å– SHMPATHNAME_PROCESS  SHMID_DEVICE_STATUS çš„shmKeyå¼‚å¸¸&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> shmid = shmget(shmKey, SHMSIZE_STATUS, IPC_CREAT|<span class="number">0600</span>);   <span class="comment">// åˆ›å»ºå…±äº«å†…å­˜, å†…å­˜é•¿åº¦ä¸ºSHM_SIZE</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget SHMID_DEVICE_STATUS error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> *shm_device_status = (<span class="type">int</span> *) shmat(shmid, (<span class="type">void</span>*)<span class="number">0</span>, <span class="number">0</span>); <span class="comment">// è¿æ¥å…±äº«å†…å­˜</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬äºŒä¸ªå…±äº«å˜é‡</span></span><br><span class="line">    shmKey = ftok(SHMPATHNAME_PROCESS, SHMID_BATTERY_VOLTAGE);  <span class="comment">// åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é”®</span></span><br><span class="line">    shmid = shmget(shmKey, SHMSIZE_VOL, IPC_CREAT|<span class="number">0600</span>);   <span class="comment">// åˆ›å»ºå…±äº«å†…å­˜, å†…å­˜é•¿åº¦ä¸ºSHMSHZI_VOL</span></span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget SHM_BATTERY_VOLTAGE error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> *shm_battery_voltage = (<span class="type">char</span> *) shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>); <span class="comment">// è¿æ¥å…±äº«å†…å­˜</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;<span class="number">10</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        *shm_device_status = i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;set int *shm_device_status=%d\n&quot;</span>, *shm_device_status);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">sprintf</span>(shm_battery_voltage, <span class="string">&quot;%d.000V&quot;</span>, i);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;set char *shm_battery_voltage=%s\n&quot;</span>, shm_battery_voltage);</span><br><span class="line">       </span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line">        </span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–­å¼€å…±äº«å†…å­˜è¿æ¥</span></span><br><span class="line">    shmdt(shm_device_status);</span><br><span class="line">    shmdt(shm_battery_voltage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…±äº«å†…å­˜è¯»è¿›ç¨‹process_d.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * process_c æ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**å¼•å…¥å…¬å…±å®šä¹‰å¥½çš„å…±äº«å˜é‡å‚æ•° */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;shm_util.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€ä¸ªå…±äº«å˜é‡</span></span><br><span class="line">    <span class="type">key_t</span> shmKey = ftok(SHMPATHNAME_PROCESS, SHMID_DEVICE_STATUS);  <span class="comment">// åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é”®</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == shmKey) &#123;</span><br><span class="line">        perror(<span class="string">&quot;è·å– SHMPATHNAME_PROCESS  SHMID_DEVICE_STATUS çš„shmKeyå¼‚å¸¸&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> shmid = shmget(shmKey, SHMSIZE_STATUS, IPC_CREAT|<span class="number">0600</span>);   <span class="comment">// åˆ›å»ºå…±äº«å†…å­˜, å†…å­˜é•¿åº¦ä¸ºSHM_SIZE</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget SHMID_DEVICE_STATUS error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> *shm_device_status = (<span class="type">int</span> *) shmat(shmid, (<span class="type">void</span>*)<span class="number">0</span>, <span class="number">0</span>); <span class="comment">// è¿æ¥å…±äº«å†…å­˜</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬äºŒä¸ªå…±äº«å˜é‡</span></span><br><span class="line">    shmKey = ftok(SHMPATHNAME_PROCESS, SHMID_BATTERY_VOLTAGE);  <span class="comment">// åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é”®</span></span><br><span class="line">    shmid = shmget(shmKey, SHMSIZE_VOL, IPC_CREAT|<span class="number">0600</span>);   <span class="comment">// åˆ›å»ºå…±äº«å†…å­˜, å†…å­˜é•¿åº¦ä¸ºSHMSHZI_VOL</span></span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget SHM_BATTERY_VOLTAGE error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> *shm_battery_voltage = (<span class="type">char</span> *) shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>); <span class="comment">// è¿æ¥å…±äº«å†…å­˜</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;<span class="number">10</span>)</span><br><span class="line">    &#123;   </span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;process_d read int *shm_device_status: %d\n&quot;</span>, *shm_device_status);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;process_d read char *shm_battery_voltage: %s\n&quot;</span>, shm_battery_voltage);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–­å¼€å…±äº«å†…å­˜è¿æ¥</span></span><br><span class="line">    shmdt(shm_device_status);</span><br><span class="line">    shmdt(shm_battery_voltage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘Makefile</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">TARGETS = process_c process_d</span><br><span class="line"></span><br><span class="line"><span class="comment"># # åˆ—å‡ºæ‰€æœ‰.cæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># SRCS = $(wildcard *.c)</span></span><br><span class="line"><span class="comment"># # æ ¹æ®SRCSç”Ÿæˆç‚¹oæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># OBJS = $(patsubst %.c, %.c.o, $(SRCS))</span></span><br><span class="line"></span><br><span class="line">SRCS1=process_c.c</span><br><span class="line">OBJS1=$(SRCS1:.c=.o)</span><br><span class="line"></span><br><span class="line">SRCS2=process_d.c</span><br><span class="line">OBJS2=$(SRCS2:.c=.o)</span><br><span class="line"></span><br><span class="line"><span class="section">all: <span class="variable">$(TARGETS)</span> </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">process_c: <span class="variable">$(OBJS1)</span></span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$^</span> <span class="variable">$(LIBS)</span> <span class="variable">$(LDFLAGS)</span> <span class="variable">$(LOCAL_LDFLAGS)</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">process_d: <span class="variable">$(OBJS2)</span></span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$^</span> <span class="variable">$(LIBS)</span> <span class="variable">$(LDFLAGS)</span> <span class="variable">$(LOCAL_LDFLAGS)</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">process_c.o: process_c.c</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$(INCLUDES)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">process_d.o: process_d.c</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$(INCLUDES)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf <span class="variable">$(TARGETS)</span> <span class="variable">$(OBJS1)</span> <span class="variable">$(OBJS2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all clean</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘æ‰§è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">keyinwang@WondersWL:~/Projects/DemoC/shared_mem$ make</span><br><span class="line">cc   -c process_c.c -o process_c.o</span><br><span class="line">cc process_c.o    -o process_c</span><br><span class="line">cc   -c process_d.c -o process_d.o</span><br><span class="line">cc process_d.o    -o process_d</span><br><span class="line"></span><br><span class="line">// ç»ˆç«¯1æ‰§è¡Œ</span><br><span class="line">keyinwang@WondersWL:~/Projects/DemoC/shared_mem$ ./process_c </span><br><span class="line">set int *shm_device_status=0</span><br><span class="line">set char *shm_battery_voltage=0.000V</span><br><span class="line">set int *shm_device_status=1</span><br><span class="line">set char *shm_battery_voltage=1.000V</span><br><span class="line">set int *shm_device_status=2</span><br><span class="line">set char *shm_battery_voltage=2.000V</span><br><span class="line">set int *shm_device_status=3</span><br><span class="line">set char *shm_battery_voltage=3.000V</span><br><span class="line"></span><br><span class="line">// ç»ˆç«¯2æ‰§è¡Œ</span><br><span class="line">keyinwang@WondersWL:~/Projects/DemoC/shared_mem$ ./process_d</span><br><span class="line">process_d read int *shm_device_status: 2</span><br><span class="line">process_d read char *shm_battery_voltage: 2.000V</span><br><span class="line">process_d read int *shm_device_status: 2</span><br><span class="line">process_d read char *shm_battery_voltage: 2.000V</span><br><span class="line">process_d read int *shm_device_status: 3</span><br><span class="line">process_d read char *shm_battery_voltage: 3.000V</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œå®Œæˆäº†å¤šä¸ªè¿›ç¨‹åªæƒ³çš„å…±äº«å†…å­˜ä½¿ç”¨ã€‚</p>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>åµŒå…¥å¼Linux</tag>
        <tag>C/C++</tag>
      </tags>
  </entry>
</search>
